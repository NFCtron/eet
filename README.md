# eet

[![npm](https://img.shields.io/npm/v/@nfctron/eet.svg)](https://www.npmjs.com/package/@nfctron/eet)
[![build status](https://img.shields.io/github/workflow/status/NFCtron/eet/CI?logo=github)](https://github.com/NFCtron/eet/actions?query=workflow%3ACI)
[![eet channel on discord](https://img.shields.io/badge/discord-join%20chat-61dafb.svg?logo=discord&logoColor=white)](https://discord.gg/bg3yazg)

Node.js library for EET ([Electronic Registration of Sales](http://www.etrzby.cz/assets/cs/prilohy/EET_popis_rozhrani_v3.1.1_EN.pdf) in the Czech Republic) ([Elektronickou evidenci tržeb](http://www.etrzby.cz/cs/technicka-specifikace)).

Fast, simple and almost [no dependencies](http://npm.broofa.com/?q=@nfctron/eet).

## Content

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->


- [Installation](#installation)
- [Example usage](#example-usage)
- [Convert .p12 to .pem](#convert-p12-to-pem)
  - [Using OpenSSL CLI](#using-openssl-cli)
  - [Using Node.js library pem](#using-nodejs-library-pem)
- [API](#api)
  - [sendEETRequest(request, options)](#sendeetrequestrequest-options)
  - [Request](#request)
  - [Options](#options)
- [Errors](#errors)
  - [ResponseServerError(message, code)](#responseservererrormessage-code)
  - [ResponseParsingError(message, code, line)](#responseparsingerrormessage-code-line)
  - [RequestParsingError(message)](#requestparsingerrormessage)
  - [WrongServerResponse(message](#wrongserverresponsemessage)
- [License](#license)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->


## Installation 

**Requirements:** **at least Node.js 10 or newer**

Using npm:

```bash
npm install @nfctron/eet --save
```

or using Yarn:

```bash
yarn add @nfctron/eet
```


## Example usage

```javascript
const { sendEETRequest } = require('eet');

const options = {
	privateKey: PRIVATE_KEY,
	certificate: CERTIFICATE,
	playground: true,
};
const items = {
	dicPopl: 'CZ1212121218',
	idProvoz: 273,
	idPokl: '/554/RO24',
	poradCis: '0/6460/ZQ42',
	datTrzby: new Date(),
	celkTrzba: 12100, // 121 CZK
	zaklDan1: 10000, // 100 CZK
	dan1: 2100, // 21 CZK
};

// send request to obtain the FIK using async/await (Node.js 10+ / Babel)
try {
    const { response } = sendEETRequest(items, options);
    console.log('ok', response);
}
catch (e) {
  console.error(e);
}


// send request to obtain the FIK using raw Promises
sendEETRequest(items, options)
	.then(({ response }) => {
		console.log('ok', response);
	})
	.catch(err => {
		console.error('error', err);
	});
```


## Convert .p12 to .pem

This library works only with certificates and keys in string format [PEM](https://en.wikipedia.org/wiki/Privacy-Enhanced_Mail).
However the certificates generated by the [EET app](http://adisspr.mfcr.cz/adistc/adis/idpr_pub/eet/eet_sluzby.faces)
of Financni sprava are in the the binary [PKCS #12](https://en.wikipedia.org/wiki/PKCS_12) format
and thus they need to be converted.


### Using OpenSSL CLI

We can use OpenSSL CLI to convert the original [PKCS #12](https://en.wikipedia.org/wiki/PKCS_12) `original.p12`
certificate (with included private key) to the [PEM](https://en.wikipedia.org/wiki/Privacy-Enhanced_Mail)
certificate and private key. You'll be prompted to enter the password of the PKCS #12 `original.p12` container.
In case of testing certificates downloaded from etrzby.cz, it is `eet`.

```bash
openssl pkcs12 -in original.p12 -nocerts -nodes -out privkey.key
openssl pkcs12 -in original.p12 -clcerts -nokeys -out cert.pem
```


### Using Node.js library [pem](https://github.com/andris9/pem)

For example using package [pem](https://github.com/andris9/pem):

```javascript
const pem = require('pem');

const file = require('fs').readFileSync('path/to/certificate.p12');
const password = '...'; // testing certificates downloaded from etrzby.cz have password 'eet'

pem.readPkcs12(file, { p12Password: password }, (err, result) => {
	if (err) ...
	// result.key je is a private key
	// result.cert je is a certificate
});
```


## API

### sendEETRequest(request, options)

The only function to call is `sendEETRequest(items, options)`.

### Request

Request items are specified in [Popis rozhraní](https://www.etrzby.cz/assets/cs/prilohy/EET_popis_rozhrani_v3.1.1.pdf).
Names are converted from snake_case to camelCase.

| name            | type    | required     | default     |
|-----------------|---------|--------------|-------------|
| uuidZpravy      | string  | no           | random UUID |
| datOdesl        | Date    | no           | Date.now()  |
| prvniZaslani    | boolean | no           | true        |
| overeni         | boolean | no           | false       |
| dicPopl         | string  | **yes**      |             |
| dicPoverujiciho | string  | no           |             |
| idProvoz        | number  | **yes**      |             |
| idPokl          | string  | **yes**      |             |
| poradCis        | string  | **yes**      |             |
| datTrzby        | Date    | **yes**      |             |
| celkTrzba       | number  | **yes**      |             |
| zaklNepodlDph   | number  | no           |             |
| zaklDan1        | number  | no           |             |
| dan1            | number  | no           |             |
| zaklDan2        | number  | no           |             |
| dan2            | number  | no           |             |
| zaklDan3        | number  | no           |             |
| dan3            | number  | no           |             |
| cestSluz        | number  | no           |             |
| pouzitZboz1     | number  | no           |             |
| pouzitZboz2     | number  | no           |             |
| pouzitZboz3     | number  | no           |             |
| urcenoCerpZuct  | number  | no           |             |
| cerpZuct        | number  | no           |             |
| rezim           | number  | no           | 0           |


### Options

| name                | type        | required     | default                                 | description                                                                                                 |
|---------------------|-------------|--------------|-----------------------------------------|-------------------------------------------------------------------------------------------------------------|
| privateKey          | KeyLike     | **yes**      |                                         | Private key for request digital signature                                                                   |
| certificate         | KeyLike     | **yes**      |                                         | Certificate containing public key associated to the private key                                             |
| timeout             | number      | no           | 10000                                   | Response timeout in milliseconds                                                                             |
| playground          | boolean     | no           | false                                   | Uses playground URL instead of production URL to submit data                                                |
| measureResponseTime | boolean     | no           | false                                   | Measure time from request to response, returned in response.requestTime                                     |
| userAgent           | string      | no           | 'nfctron/eet (+github.com/NFCtron/eet)' | Custom HTTP User-Agent header                                                                               |
| agent               | https.Agent | no           |                                         | Custom Node [HTTPS Agent](https://nodejs.org/api/https.html#https_class_https_agent) to send request through |

## Errors

### ResponseServerError(message, code)

EET server returned <Error> tag. All possible error are specified in [Popis rozhraní](https://www.etrzby.cz/assets/cs/prilohy/EET_popis_rozhrani_v3.1.1.pdf).
Most notably *Neplatny podpis SOAP zpravy (4)* means that private key or certificate are in wrong format.
They need to begin with `-----BEGIN RSA PRIVATE KEY-----` and `-----BEGIN CERTIFICATE-----` respectively.  

### ResponseParsingError(message, code, line)

EET server responded with invalid XML.

### RequestParsingError(message)

Request parameter is empty, doesn't contain all required items or there is an invalid field.
Check if all required items are supplied and in the correct format specified in [Popis rozhraní](https://www.etrzby.cz/assets/cs/prilohy/EET_popis_rozhrani_v3.1.1.pdf).

### WrongServerResponse(message)

EET server responded with invalid XML or didn't return required fields.

## License

[MIT](/LICENSE.md)
