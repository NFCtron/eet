# eet

[![npm](https://img.shields.io/npm/v/@nfctron/eet.svg)](https://www.npmjs.com/package/@nfctron/eet)
[![build status](https://img.shields.io/github/workflow/status/NFCtron/eet/CI?logo=github)](https://github.com/NFCtron/eet/actions?query=workflow%3ACI)
[![eet channel on discord](https://img.shields.io/badge/discord-join%20chat-61dafb.svg?logo=discord&logoColor=white)](https://discord.gg/bg3yazg)

Node.js library for EET ([Electronic Registration of Sales](http://www.etrzby.cz/assets/cs/prilohy/EET_popis_rozhrani_v3.1.1_EN.pdf) in the Czech Republic) ([Elektronickou evidenci tržeb](http://www.etrzby.cz/cs/technicka-specifikace)).


## Content

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->


- [Installation](#installation)
- [Example usage](#example-usage)
- [Convert .p12 to .pem](#convert-p12-to-pem)
  - [Using OpenSSL CLI](#using-openssl-cli)
  - [Using Node.js library pem](#using-nodejs-library-pem)
- [API](#api)
  - [createClient(options)](#createclientoptions)
  - [EETClient.request(items)](#eetclientrequestitems)
- [Frequent errors](#frequent-errors)
  - [Neplatny podpis SOAP zpravy (4)](#neplatny-podpis-soap-zpravy-4)
- [License](#license)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->


## Installation 

**Requirements:** **at least Node.js 8 or newer**

Using npm:

```bash
npm install @nfctron/eet --save
```

or using Yarn:

```bash
yarn add @nfctron/eet
```


## Example usage

```javascript
const { createClient } = require('eet');

const options = {
	privateKey: '...',
	certificate: '...',
	playground: true,
};

const items = {
	dicPopl: 'CZ1212121218',
	idPokl: '/5546/RO24',
	poradCis: '0/6460/ZQ42',
	datTrzby: new Date(),
	celkTrzba: 34113, // 341.13 CZK expressed in hundredths (haléře, aka cents)
	idProvoz: 273,
};

// send request to obtain the FIK using async/await (Node.js 8+ / Babel)

const client = await createClient(options);

try {
	const { fik } = await client.request(items);
}

// send request to obtain the FIK using raw Promises
createClient(options)
	.then(client => client.request(items))
	.then((({ request, response }) => {
		// request contains complete data object sent to EET
		// response.fik
	}));
```


## Convert .p12 to .pem

This library works only with certificates and keys in string format [PEM](https://en.wikipedia.org/wiki/Privacy-Enhanced_Mail).
However the certificates generated by the [EET app](http://adisspr.mfcr.cz/adistc/adis/idpr_pub/eet/eet_sluzby.faces)
of Financni sprava are in the the binary [PKCS #12](https://en.wikipedia.org/wiki/PKCS_12) format
and thus they need to be converted.


### Using OpenSSL CLI

We can use OpenSSL CLI to convert the original [PKCS #12](https://en.wikipedia.org/wiki/PKCS_12) `original.p12`
certificate (with included private key) to the [PEM](https://en.wikipedia.org/wiki/Privacy-Enhanced_Mail)
certificate and private key. You'll be prompted to enter the password of the PKCS #12 `original.p12` container.
In case of testing certificates downloaded from etrzby.cz, it is `eet`.

```bash
openssl pkcs12 -in original.p12 -clcerts -nocerts -nodes | openssl rsa > privkey.key
openssl pkcs12 -in original.p12 -clcerts -nokeys -out cert.pem
```


### Using Node.js library [pem](https://github.com/andris9/pem)

For example using package [pem](https://github.com/andris9/pem):

```javascript
const pem = require('pem');

const file = require('fs').readFileSync('path/to/certificate.p12');
const password = '...'; // testing certificates downloaded from etrzby.cz have password 'eet'

pem.readPkcs12(file, { p12Password: password }, (err, result) => {
	if (err) ...
	// result.key je is a private key
	// result.cert je is a certificate
});
```


## API


### createClient(options)

|        name         |  type   | required | default |                                                      description                                                       |
|---------------------|---------|----------|---------|------------------------------------------------------------------------------------------------------------------------|
| **privateKey**      | string  | **yes**  |         | private key for the certificate                                                                                        |
| **certificate**     | string  | **yes**  |         | certificate                                                                                                            |
| offline             | boolean | no       | false   | if true, includes PKP and BKB in response on unsuccessful request to EET                                               |
| playground          | boolean | no       | false   | use Playground EET endpoint instead of production                                                                      |
| timeout             | number  | no       | 2000 ms | maximal time to wait in milliseconds                                                                                   |
| measureResponseTime | boolean | no       | false   | measure response time using node-soap's [client.lastElapsedTime](https://github.com/vpulim/node-soap#options-optional) |
| httpClient          | object  | no       |         | see [soap options](https://github.com/vpulim/node-soap#options), just for testing                                      |


### EETClient.request(items)

* *items* - data to send in EET request, same name as in EET specification but in camel case (so instead of `dic_popl` use `dicPopl`)

	**TODO** add table of items (required, data type, and description)


TODO document whole API


## Frequent errors

### Neplatny podpis SOAP zpravy (4)

It is probably due the invalid certificate. Check that the certificate file starts with `-----BEGIN CERTIFICATE-----`.
If not, remove any preceding text (e.g. Bag Attributes ...).


## License

[MIT](/LICENSE.md)
