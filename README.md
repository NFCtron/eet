# eet

[![npm](https://img.shields.io/npm/v/@nfctron/eet.svg)](https://www.npmjs.com/package/@nfctron/eet)
[![build status](https://img.shields.io/github/workflow/status/NFCtron/eet/CI?logo=github)](https://github.com/NFCtron/eet/actions?query=workflow%3ACI)
[![eet channel on discord](https://img.shields.io/badge/discord-join%20chat-61dafb.svg?logo=discord&logoColor=white)](https://discord.gg/bg3yazg)

Node.js library for EET ([Electronic Registration of Sales](http://www.etrzby.cz/assets/cs/prilohy/EET_popis_rozhrani_v3.1.1_EN.pdf) in the Czech Republic) ([Elektronickou evidenci tržeb](http://www.etrzby.cz/cs/technicka-specifikace)).

Fast, simple and almost [no dependencies](http://npm.broofa.com/?q=@nfctron/eet).

## Content

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->


- [Installation](#installation)
- [Example usage](#example-usage)
- [Convert .p12 to .pem](#convert-p12-to-pem)
  - [Using OpenSSL CLI](#using-openssl-cli)
  - [Using Node.js library pem](#using-nodejs-library-pem)
- [API](#api)
- [Error handling](#error-handling)
  - [ResponseServerError(message, code)](#responseservererrormessage-code)
  - [ResponseParsingError(message, code, line)](#responseparsingerrormessage-code-line)
  - [RequestParsingError(message)](#requestparsingerrormessage)
  - [WrongServerResponse(message)](#wrongserverresponsemessage)
- [FAQ](#faq)
  - [Can this library be used directly in the browser?](#can-this-library-be-used-directly-in-the-browser)
- [Missing features](#missing-features)
- [License](#license)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->


## Installation 

**Requirements:** **at least Node.js 10 or newer**

Using npm:

```bash
npm install @nfctron/eet --save
```

or using Yarn:

```bash
yarn add @nfctron/eet
```


## Example usage

```javascript
const { sendEETRequest } = require('@nfctron/eet');

// for example: you can load private key and certificate from file
// note: do not use readFileSync in the server
//       because it will block the entire process until it completes
//       use an asynchronous readFile instead
//       (or load it from database or whatever works best for your use-case)
const fs = require('fs');
const PRIVATE_KEY = fs.readFileSync('path/to/private-key.pem');
const CERTIFICATE = fs.readFileSync('path/to/certificate.pem');

const options = {
	privateKey: PRIVATE_KEY,
	certificate: CERTIFICATE,
	playground: true,
};

const items = {
	dicPopl: 'CZ1212121218',
	idProvoz: 273,
	idPokl: '/554/RO24',
	poradCis: '0/6460/ZQ42',
	datTrzby: new Date(),
	celkTrzba: 12100, // 121.00 CZK
	zaklDan1: 10000, // 100.00 CZK
	dan1: 2100, // 21.00 CZK
};

// send request to obtain the FIK using async/await
try {
	const { response } = sendEETRequest(items, options);
	console.log('ok', response);
	// the response looks like:
	// {
	//   uuidZpravy: '2dadefae-9926-403a-ace5-78f61a7a7882',
	//   datPrij: 2020-03-27T20:51:48.000Z,
	//   bkp: '032faa83-168bc061-4630c051-fce41ffa-dbc90815',
	//   test: true,
	//   fik: '09dfc04d-9e71-413a-9465-46bcf8ef3d0d-fa',
	//   warnings: []
	// }
}
catch (e) {
	console.error(e);
}

// alternatively you can use raw Promises ...
sendEETRequest(items, options)
	.then(({ response }) => {
		console.log('ok', response);
	})
	.catch(err => {
		console.error('error', err);
	});
```


## Convert .p12 to .pem

This library works only with certificates and keys in string format [PEM](https://en.wikipedia.org/wiki/Privacy-Enhanced_Mail).
However the certificates generated by the [EET app](http://adisspr.mfcr.cz/adistc/adis/idpr_pub/eet/eet_sluzby.faces)
of Financni sprava are in the the binary [PKCS #12](https://en.wikipedia.org/wiki/PKCS_12) format
and thus they need to be converted.


### Using OpenSSL CLI

We can use OpenSSL CLI to convert the original [PKCS #12](https://en.wikipedia.org/wiki/PKCS_12) `original.p12`
certificate (with included private key) to the [PEM](https://en.wikipedia.org/wiki/Privacy-Enhanced_Mail)
certificate and private key. You'll be prompted to enter the password of the PKCS #12 `original.p12` container.
In case of testing certificates downloaded from etrzby.cz, it is `eet`.

```bash
openssl pkcs12 -in original.p12 -nocerts -nodes -out privkey.key
openssl pkcs12 -in original.p12 -clcerts -nokeys -out cert.pem
```


### Using Node.js library [pem](https://github.com/andris9/pem)

For example using package [pem](https://github.com/andris9/pem):

```javascript
const pem = require('pem');
const fs = require('fs');

const file = fs.readFileSync('path/to/certificate.p12');
const password = '...'; // testing certificates downloaded from etrzby.cz have password 'eet'

pem.readPkcs12(file, { p12Password: password }, (err, result) => {
	if (err) ...
	// result.key je is a private key
	// result.cert je is a certificate
});
```


## API

Public API is documented using a **TypeScript definition** in [src/index.d.ts](/src/index.d.ts).
All notable options and values and their behavior is described in comments.


## Error handling

The are two types of error: fetch errors and custom EET errors. All errors contain generated `bkp` and `pkp` codes.

### Fetch errors

[FetchError](https://github.com/node-fetch/node-fetch/blob/master/docs/ERROR-HANDLING.md) comes from [node-fetch](https://github.com/node-fetch/node-fetch) library, 
every error is rethrown with extra `bkp` and `pkp` fields.


### ResponseServerError(message, code)

EET server returned <Error> tag. All possible error are specified in [Popis rozhraní](https://www.etrzby.cz/assets/cs/prilohy/EET_popis_rozhrani_v3.1.1.pdf).
Most notably *Neplatny podpis SOAP zpravy (4)* means that private key or certificate are in wrong format.
They need to begin with `-----BEGIN RSA PRIVATE KEY-----` and `-----BEGIN CERTIFICATE-----` respectively.  

### ResponseParsingError(message, code, line)

EET server responded with invalid XML.

### RequestParsingError(message)

Request parameter is empty, doesn't contain all required items or there is an invalid field.
Check if all required items are supplied and in the correct format specified in [Popis rozhraní](https://www.etrzby.cz/assets/cs/prilohy/EET_popis_rozhrani_v3.1.1.pdf).

### WrongServerResponse(message)

EET server responded with invalid XML or didn't return required fields.


## FAQ

### Can this library be used directly in the browser?

Currently, it is not possible. But it could be done:
1. CORS > must be disabled in the browser or all request must be sent via a proxy
2. process.hrtime.bigint() > can be easily replaced
3. Node.js crypto in src/crypto.js > can be easily replaced by [SubtleCrypto.digest](https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/digest) the Web Crypto API
4. node-fetch > not needed as Fetch API is available in the browser


## Missing features

* Verifying response signature
All communication must be digitally signed. Currently we are unable to transform response XML into canonical form 
in order to verify sender's signature. However a `rawResponse` field is returned, so it can be saved and verified later.
Nevertheless all communication is encrypted and verified via HTTPS/TLS, so it is very difficult to forge response.


## License

[MIT](/LICENSE.md)
